<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Instagramフォロー分析</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #fafafa;
      color: #262626;
      margin: 20px;
      text-align: center;
    }
    h2 { margin-bottom: 10px; }
    .controls { margin: 10px 0; }
    button {
      background: #e1306c;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      margin: 2px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { opacity: 0.85; }
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 95%;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background: #f0f0f0;
      font-weight: 600;
    }
    .green { color: #27ae60; font-weight: bold; }
    .red { color: #c0392b; font-weight: bold; }
    .black { color: #000; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Instagram フォロー/フォロワー 推移</h2>

  <div class="controls">
    <button onclick="setRange(7)">直近7日</button>
    <button onclick="setRange(14)">直近14日</button>
    <button onclick="setRange(30)">直近30日</button>
    <button onclick="setRange(90)">直近90日</button>
  </div>

  <div class="controls">
    開始日: <input type="date" id="startDate">
    終了日: <input type="date" id="endDate">
    <button onclick="applyCustomRange()">期間指定表示</button>
  </div>

  <div class="controls">
    <button onclick="setYAxisMode('zero')">縦軸: 0から</button>
    <button onclick="setYAxisMode('min')">縦軸: 最小値から</button>
  </div>

  <canvas id="myChart" height="100"></canvas>
  <div style="font-size:12px; margin-top:5px;">※グラフはピンチ/スクロールで拡大・移動、ダブルタップでリセットできます</div>

  <h3>データ表</h3>
  <table id="dataTable">
    <thead>
      <tr>
        <th>日付</th>
        <th>フォロワー数</th>
        <th>フォロワー増減<br>(直近7日平均)</th>
        <th>フォロー数</th>
        <th>フォロー増減</th>
        <th>フォローバック率</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTvabzaDpfs0f1sm9hfufcmqqw3_M_hd6Gz5VHgUAyRR3q4fkzRVmeqW-FWJlJu4dTSCKcwkdZkTGDl/pub?output=csv";

    let rawData = [];
    let chart;
    let yAxisMode = "zero";

    async function fetchData() {
      const res = await fetch(csvUrl);
      const text = await res.text();
      const rows = text.trim().split("\n").map(r => r.split(","));
      rawData = rows.slice(1).map(r => ({
        date: new Date(r[0]),
        followers: Number(r[1]),
        following: Number(r[2])
      }));
      setRange(30);
    }

    function setRange(days) {
      const end = new Date();
      const start = new Date();
      start.setDate(end.getDate() - days + 1);
      const filtered = rawData.filter(d => d.date >= start && d.date <= end);
      drawChart(filtered);
      drawTable(filtered);
    }

    function applyCustomRange() {
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      const filtered = rawData.filter(d => d.date >= start && d.date <= end);
      drawChart(filtered);
      drawTable(filtered);
    }

    function setYAxisMode(mode) {
      yAxisMode = mode;
      setRange(30);
    }

    function drawChart(data) {
      const labels = data.map(d => d.date.toISOString().split("T")[0]);
      const followers = data.map(d => d.followers);
      const following = data.map(d => d.following);

      const maxVal = Math.max(...followers, ...following);
      const minVal = Math.min(...followers, ...following);

      let stepSize = 50;
      if (maxVal <= 1000) stepSize = 50;
      else if (maxVal <= 10000) stepSize = 100;
      else if (maxVal <= 50000) stepSize = 500;
      else if (maxVal <= 100000) stepSize = 1000;
      else stepSize = 5000;

      const ctx = document.getElementById("myChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "フォロワー数",
              data: followers,
              borderColor: "#e1306c",
              backgroundColor: "rgba(225,48,108,0.15)",
              fill: true,
              tension: 0.3,
              pointRadius: 3
            },
            {
              label: "フォロー数",
              data: following,
              borderColor: "#3867d6",
              backgroundColor: "rgba(56,103,214,0.15)",
              fill: true,
              tension: 0.3,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            zoom: {
              pan: { enabled: true, mode: "xy" },
              zoom: { wheel: { enabled: true }, pinch: { enabled: true }, drag: { enabled: true }, mode: "xy" }
            }
          },
          scales: {
            x: { ticks: { maxRotation: 90, minRotation: 45 } },
            y: {
              beginAtZero: yAxisMode === "zero",
              min: yAxisMode === "min" ? minVal - stepSize : undefined,
              ticks: { stepSize: stepSize }
            }
          }
        }
      });

      document.getElementById("myChart").ondblclick = () => chart.resetZoom();
    }

    function drawTable(data) {
      const tbody = document.querySelector("#dataTable tbody");
      tbody.innerHTML = "";
      for (let i = 0; i < data.length; i++) {
        const d = data[i];
        const prev = i > 0 ? data[i-1] : null;
        const diffFollowers = prev ? d.followers - prev.followers : 0;
        const diffFollowing = prev ? d.following - prev.following : 0;

        // 直近7日平均
        const recent7 = data.slice(Math.max(0, i-6), i+1);
        const avg7 = recent7.length > 1 ? 
          (recent7[recent7.length-1].followers - recent7[0].followers) / (recent7.length-1) : 0;

        // フォローバック率
        const followBackRate = d.following > 0 ? (d.followers / d.following) * 100 : 0;
        let rateClass = "black";
        if (followBackRate > 55) rateClass = "green";
        else if (followBackRate < 45) rateClass = "red";

        // 増減の色
        const diffFollowersClass = diffFollowers > 0 ? "green" : diffFollowers < 0 ? "red" : "black";
        const diffFollowingClass = diffFollowing > 0 ? "green" : diffFollowing < 0 ? "red" : "black";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${d.date.toISOString().split("T")[0]}</td>
          <td>${d.followers}</td>
          <td class="${diffFollowersClass}">${diffFollowers>=0?"+":""}${diffFollowers} (${avg7.toFixed(1)})</td>
          <td>${d.following}</td>
          <td class="${diffFollowingClass}">${diffFollowing>=0?"+":""}${diffFollowing}</td>
          <td class="${rateClass}">${followBackRate.toFixed(1)}%</td>
        `;
        tbody.appendChild(tr);
      }
    }

    fetchData();
  </script>
</body>
</html>
