<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Instagram Stats</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h1 { font-size: 1.5em; }
    button { margin: 5px; padding: 5px 10px; }
    input[type="date"] { margin: 5px; }
    #chart-container { width: 100%; max-width: 800px; }
  </style>
</head>
<body>
  <h1>Instagram フォロワー/フォロー推移</h1>

  <!-- 集計期間ボタン -->
  <div>
    <button onclick="setRange(7)">直近7日</button>
    <button onclick="setRange(30)">直近30日</button>
    <button onclick="setRange(90)">直近90日</button>
  </div>

  <!-- カレンダー指定 -->
  <div>
    開始日: <input type="date" id="startDate">
    終了日: <input type="date" id="endDate">
    <button onclick="applyCustomRange()">期間を適用</button>
  </div>

  <!-- グラフ -->
  <div id="chart-container">
    <canvas id="myChart"></canvas>
  </div>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTvabzaDpfs0f1sm9hfufcmqqw3_M_hd6Gz5VHgUAyRR3q4fkzRVmeqW-FWJlJu4dTSCKcwkdZkTGDl/pub?output=csv";

    let allData = [];
    let chart;

    // CSVを読み込む
    fetch(csvUrl)
      .then(res => res.text())
      .then(csv => {
        const rows = csv.trim().split("\n").map(r => r.split(","));
        rows.shift(); // ヘッダー削除
        allData = rows.map(r => ({
          date: new Date(r[0]),
          followers: Number(r[1]),
          following: Number(r[2])
        }));
        setRange(30); // 初期表示: 直近30日
      });

    // 直近N日表示
    function setRange(days) {
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);
      const data = allData.filter(d => d.date >= cutoff);
      drawChart(data);
    }

    // 任意期間指定
    function applyCustomRange() {
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      if (!start || !end) return;
      const data = allData.filter(d => d.date >= start && d.date <= end);
      drawChart(data);
    }

    // グラフ描画
    function drawChart(data) {
      const labels = data.map(d => d.date.toISOString().split("T")[0]);
      const followers = data.map(d => d.followers);
      const following = data.map(d => d.following);

      const ctx = document.getElementById("myChart").getContext("2d");

      if (chart) chart.destroy(); // 既存グラフを消す

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [
            {
              label: "フォロワー数",
              data: followers,
              borderColor: "blue",
              backgroundColor: "rgba(0,0,255,0.1)",
              fill: true,
              tension: 0.2
            },
            {
              label: "フォロー数",
              data: following,
              borderColor: "green",
              backgroundColor: "rgba(0,255,0,0.1)",
              fill: true,
              tension: 0.2
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" },
            title: { display: true, text: "Instagram 推移グラフ" }
          },
          scales: {
            x: { ticks: { maxRotation: 90, minRotation: 45 } },
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
</body>
</html>
